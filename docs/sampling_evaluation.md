# 小分子溶剂化增强采样结果评估方案（通用框架）

## 评估目标
为**概率流自由能差估计方法**评估端点玻尔兹曼分布的采样质量。

核心问题：采样是否真正代表了目标温度下的**平衡玻尔兹曼分布**？

---

## 核心评估维度

### 维度一：平衡分布的代表性
概率流方法要求端点是真实的玻尔兹曼分布，因此：
- 采样必须**收敛**到平衡态
- 采样必须有足够的**统计代表性**（ESS）
- 相空间的重要区域必须被**充分覆盖**

### 维度二：无先验假设的通用性
适用于任意小分子（暂不考虑带环分子），不依赖预知的构象信息。

---

## 一、平衡收敛性评估（最关键）

### 1.1 块平均分析 (Block Averaging)
- 将轨迹分成N块（建议4-8块）
- 计算每块的构象分布（二面角直方图或PCA投影密度）
- **关键指标**：
  - 块间分布的JS散度
  - 后半段 vs 前半段分布的相似度
- **判据**：JS散度 < 0.1，相似度 > 0.9

### 1.2 自相关时间分析
- 计算关键自由度（RMSD相对参考构象、主要二面角）的自相关函数
- 估计积分自相关时间 τ_int
- **有效独立样本数** N_eff = N_total / (2τ_int)
- **判据**：N_eff > 100（概率流需要足够的独立样本）

### 1.3 累积指标收敛曲线
- 绘制采样时间 vs 各指标（平均能量、平均RMSD、PCA质心等）
- **判据**：指标达到平台期并保持稳定

---

## 二、构象空间覆盖度评估

### 2.1 可旋转二面角分布
- 自动检测可旋转键（排除环内键，留作后续TODO）
- 绘制每个可旋转二面角的概率密度
- **指标**：
  - 多峰分布是否每个峰都有充足采样
  - 各势阱的采样比例是否符合玻尔兹曼权重

### 2.2 基于RMSD的构象聚类
- 对小分子重原子进行RMSD聚类
- **指标**：
  - 聚类数量随时间是否稳定
  - 主要构象态的采样比例

### 2.3 PCA覆盖分析
- 对内坐标进行PCA降维
- **指标**：
  - PC1-PC2平面的采样分布
  - 是否存在明显的未探索"空洞"

### 2.4 构象转变事件
- 检测主要构象态间的转变次数
- **判据**：每对主要状态间至少有多次往返转变

---

## 三、Replica Exchange效率评估

### 3.1 交换接受率
- **理想范围**：20-40%
- 过低（<15%）→ 温度间隔太大，采样效率低
- 过高（>50%）→ 资源利用不充分

### 3.2 Replica温度扩散图
- 绘制每个replica随时间在不同温度层的轨迹
- **判据**：replica应能在整个温度范围内random walk

### 3.3 Round-trip统计
- 从最低温到最高温再返回的次数
- **判据**：至少完成3次round-trip

---

## 四、统计质量评估

### 4.1 有效样本数 (ESS)
- 使用pymbar计算目标温度下的ESS
- **判据**：ESS > 100，ESS/N_total > 10%

### 4.2 采样误差估计
- 对关键可观测量（能量、二面角分布）进行block bootstrap
- 估计均值和分布的统计误差
- **判据**：误差在可接受范围内（如能量误差 < 1 kT）

---

## 五、可视化输出

1. **收敛性诊断图**
   - 累积平均能量 vs 时间
   - 块平均分布对比（前半 vs 后半）
   - 自相关函数衰减曲线

2. **构象空间图**
   - 各可旋转二面角的概率密度分布
   - PCA投影的2D密度图
   - 构象聚类结果可视化

3. **Exchange效率图**
   - 温度-时间的replica轨迹图
   - 交换接受率统计

---

## 六、量化指标汇总表

| 评估维度 | 指标 | 判据 | 优先级 |
|---------|------|------|--------|
| 收敛性 | 块间JS散度 | < 0.1 | ⭐⭐⭐ |
| 收敛性 | 前后半分布相似度 | > 0.9 | ⭐⭐⭐ |
| 收敛性 | 累积指标稳定性 | 达到平台期 | ⭐⭐⭐ |
| 统计质量 | 有效样本数ESS | > 100 | ⭐⭐⭐ |
| 统计质量 | ESS/总样本比 | > 10% | ⭐⭐ |
| 覆盖度 | 构象聚类稳定性 | 数量不再增加 | ⭐⭐ |
| 覆盖度 | 二面角多峰覆盖 | 各峰均有采样 | ⭐⭐ |
| 覆盖度 | 状态间转变次数 | ≥ 3次往返 | ⭐⭐ |
| Exchange效率 | 交换接受率 | 20-40% | ⭐ |
| Exchange效率 | Round-trip次数 | ≥ 3 | ⭐ |

---

## 七、实现流程

```
Step 1: 加载轨迹和拓扑，提取小分子坐标
Step 2: 自动检测可旋转二面角
Step 3: 收敛性分析
        - 块平均分布对比
        - 自相关时间计算
        - 累积指标曲线
Step 4: 构象空间分析
        - 二面角分布
        - RMSD聚类
        - PCA覆盖
Step 5: Exchange效率分析（如适用）
Step 6: 统计质量评估（ESS、误差估计）
Step 7: 生成评估报告（图表 + 指标表 + 结论）
```

---

## TODO（后续扩展）
- [ ] 支持带环分子的环翻转构象分析
- [ ] 与参考分布（如从更长模拟获得）的定量对比

---

## 所需依赖
- MDTraj/MDAnalysis: 轨迹处理、二面角计算
- scikit-learn: 聚类、PCA
- pymbar: ESS计算
- scipy: 统计分析（自相关、JS散度）
- matplotlib: 可视化
